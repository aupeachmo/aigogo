name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v3.0.0, v3.1.0, etc.

permissions:
  contents: write      # Required for creating releases
  id-token: write      # Required for artifact attestations
  attestations: write  # Required for artifact attestations

jobs:
  build:
    name: Build Release Binaries
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            goos: linux
            goarch: amd64
            output: aigg-linux-amd64
            extension: ""
          - runner: ubuntu-latest
            goos: linux
            goarch: arm64
            output: aigg-linux-arm64
            extension: ""
          - runner: macos-15
            goos: darwin
            goarch: amd64
            output: aigg-darwin-amd64
            extension: ""
          - runner: macos-latest
            goos: darwin
            goarch: arm64
            output: aigg-darwin-arm64
            extension: ""
          - runner: windows-latest
            goos: windows
            goarch: amd64
            output: aigg-windows-amd64
            extension: ".exe"
          - runner: windows-latest
            goos: windows
            goarch: arm64
            output: aigg-windows-arm64
            extension: ".exe"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o ${{ matrix.output }}${{ matrix.extension }} .

      - name: Strip binary (Unix)
        if: matrix.goos != 'windows' && !(matrix.goos == 'linux' && matrix.goarch == 'arm64')
        run: |
          strip ${{ matrix.output }} 2>/dev/null || true
          ls -lh ${{ matrix.output }}

      - name: Strip binary (Linux ARM64 cross-compiled)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        run: |
          which aarch64-linux-gnu-strip && aarch64-linux-gnu-strip ${{ matrix.output }} || true
          ls -lh ${{ matrix.output }}

      - name: Show binary size
        shell: bash
        run: ls -lh ${{ matrix.output }}${{ matrix.extension }}

      - name: Create tarball (Linux)
        if: matrix.goos == 'linux'
        run: |
          tar -czf ${{ matrix.output }}.tar.gz ${{ matrix.output }}
          sha256sum ${{ matrix.output }}.tar.gz > ${{ matrix.output }}.tar.gz.sha256

      - name: Create tarball (macOS)
        if: matrix.goos == 'darwin'
        run: |
          tar -czf ${{ matrix.output }}.tar.gz ${{ matrix.output }}
          shasum -a 256 ${{ matrix.output }}.tar.gz > ${{ matrix.output }}.tar.gz.sha256

      - name: Create zip (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          Compress-Archive -Path ${{ matrix.output }}${{ matrix.extension }} -DestinationPath ${{ matrix.output }}.zip
          (Get-FileHash -Algorithm SHA256 ${{ matrix.output }}.zip).Hash.ToLower() + "  ${{ matrix.output }}.zip" | Out-File -Encoding ascii ${{ matrix.output }}.zip.sha256

      - name: Attest artifact (Linux/macOS)
        if: matrix.goos == 'linux' || matrix.goos == 'darwin'
        uses: actions/attest-build-provenance@v4
        with:
          subject-path: ${{ matrix.output }}.tar.gz

      - name: Attest artifact (Windows)
        if: matrix.goos == 'windows'
        uses: actions/attest-build-provenance@v4
        with:
          subject-path: ${{ matrix.output }}.zip

      - name: Upload artifacts (Linux/macOS)
        if: matrix.goos == 'linux' || matrix.goos == 'darwin'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.output }}
          path: |
            ${{ matrix.output }}.tar.gz
            ${{ matrix.output }}.tar.gz.sha256

      - name: Upload artifacts (Windows)
        if: matrix.goos == 'windows'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.output }}
          path: |
            ${{ matrix.output }}.zip
            ${{ matrix.output }}.zip.sha256

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          # Find the previous tag (second most recent by version sort)
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -1)
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from ${PREVIOUS_TAG} to ${CURRENT_TAG}"
            CHANGELOG=$(git log --oneline --no-merges "${PREVIOUS_TAG}..${CURRENT_TAG}" | head -50)
          else
            echo "No previous tag found, listing all commits"
            CHANGELOG=$(git log --oneline --no-merges "${CURRENT_TAG}" | head -50)
          fi
          # Write to a multi-line output
          {
            echo "CHANGELOG<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz*" -exec cp {} release-assets/ \;
          find artifacts -name "*.zip*" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Delete existing release (if re-running, will silently abort if release does not exist)
        run: gh release delete ${{ steps.get_version.outputs.VERSION }} --yes --cleanup-tag=false 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: aigg ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## aigg ${{ steps.get_version.outputs.VERSION }}

            An AI agent manager

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | AMD64 | `aigg-linux-amd64.tar.gz` |
            | Linux | ARM64 | `aigg-linux-arm64.tar.gz` |
            | macOS | AMD64 (Intel) | `aigg-darwin-amd64.tar.gz` |
            | macOS | ARM64 (M1/M2/M3) | `aigg-darwin-arm64.tar.gz` |
            | Windows | AMD64 | `aigg-windows-amd64.zip` |
            | Windows | ARM64 | `aigg-windows-arm64.zip` |

            ### Installation

            ```bash
            # Linux (AMD64)
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/aigg-linux-amd64.tar.gz
            tar -xzf aigg-linux-amd64.tar.gz
            sudo mv aigg-linux-amd64 /usr/local/bin/aigg

            # Linux (ARM64)
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/aigg-linux-arm64.tar.gz
            tar -xzf aigg-linux-arm64.tar.gz
            sudo mv aigg-linux-arm64 /usr/local/bin/aigg

            # macOS (Intel)
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/aigg-darwin-amd64.tar.gz
            tar -xzf aigg-darwin-amd64.tar.gz
            sudo mv aigg-darwin-amd64 /usr/local/bin/aigg

            # macOS (Apple Silicon)
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/aigg-darwin-arm64.tar.gz
            tar -xzf aigg-darwin-arm64.tar.gz
            sudo mv aigg-darwin-arm64 /usr/local/bin/aigg

            # Windows (PowerShell)
            Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/aigg-windows-amd64.zip" -OutFile aigg.zip
            Expand-Archive aigg.zip -DestinationPath .
            Move-Item aigg-windows-amd64.exe C:\Windows\aigg.exe
            ```

            ### Verify checksums

            ```bash
            # Linux/macOS
            sha256sum -c aigg-*.sha256

            # Windows (PowerShell)
            Get-FileHash aigg-windows-amd64.zip | Format-List
            ```

            ### Verify build provenance

            All release artifacts include GitHub build attestations. Verify with:

            ```bash
            gh attestation verify aigg-linux-amd64.tar.gz --repo ${{ github.repository }}
            ```

            ### What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download checksums
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          BASE_URL="https://github.com/aupeachmo/aigogo/releases/download/v${VERSION}"

          for target in darwin-amd64 darwin-arm64 linux-amd64 linux-arm64; do
            echo "Downloading checksum for ${target}..."
            curl -sL --fail "${BASE_URL}/aigg-${target}.tar.gz.sha256" \
              | cut -d' ' -f1 > "${target}.sha"
          done

          echo "Checksums:"
          cat *.sha

      - name: Generate formula
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          DARWIN_AMD64_SHA=$(cat darwin-amd64.sha)
          DARWIN_ARM64_SHA=$(cat darwin-arm64.sha)
          LINUX_AMD64_SHA=$(cat linux-amd64.sha)
          LINUX_ARM64_SHA=$(cat linux-arm64.sha)

          cat > aigg.rb << EOF
          class Aigg < Formula
            desc "Make packaging and distributing your AI agents a breeze"
            homepage "https://github.com/aupeachmo/aigogo"
            version "${VERSION}"
            license "MPL-2.0"

            on_macos do
              on_intel do
                url "https://github.com/aupeachmo/aigogo/releases/download/v${VERSION}/aigg-darwin-amd64.tar.gz"
                sha256 "${DARWIN_AMD64_SHA}"
              end
              on_arm do
                url "https://github.com/aupeachmo/aigogo/releases/download/v${VERSION}/aigg-darwin-arm64.tar.gz"
                sha256 "${DARWIN_ARM64_SHA}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/aupeachmo/aigogo/releases/download/v${VERSION}/aigg-linux-amd64.tar.gz"
                sha256 "${LINUX_AMD64_SHA}"
              end
              on_arm do
                url "https://github.com/aupeachmo/aigogo/releases/download/v${VERSION}/aigg-linux-arm64.tar.gz"
                sha256 "${LINUX_ARM64_SHA}"
              end
            end

            def install
              if OS.mac? && Hardware::CPU.arm?
                bin.install "aigg-darwin-arm64" => "aigg"
              elsif OS.mac? && Hardware::CPU.intel?
                bin.install "aigg-darwin-amd64" => "aigg"
              elsif OS.linux? && Hardware::CPU.arm?
                bin.install "aigg-linux-arm64" => "aigg"
              elsif OS.linux?
                bin.install "aigg-linux-amd64" => "aigg"
              end
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/aigg version")
            end
          end
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' aigg.rb

          echo "Generated formula:"
          cat aigg.rb

      - name: Generate GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BREW_APP_ID }}
          private-key: ${{ secrets.BREW_APP_PRIVATE_KEY }}
          repositories: homebrew-aigogo
          owner: aupeachmo

      - name: Push formula via GitHub API (signed commit)
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Get the current file SHA (needed for updates, absent for first commit)
          CURRENT_SHA=$(gh api repos/aupeachmo/homebrew-aigogo/contents/Formula/aigg.rb \
            --jq '.sha' 2>/dev/null || echo "")

          # Base64-encode the formula
          CONTENT=$(base64 -w 0 aigg.rb)

          # Build the JSON payload
          if [ -n "$CURRENT_SHA" ]; then
            PAYLOAD=$(jq -n \
              --arg message "Update aigogo to v${VERSION}" \
              --arg content "$CONTENT" \
              --arg sha "$CURRENT_SHA" \
              '{message: $message, content: $content, sha: $sha}')
          else
            PAYLOAD=$(jq -n \
              --arg message "Update aigogo to v${VERSION}" \
              --arg content "$CONTENT" \
              '{message: $message, content: $content}')
          fi

          # Create/update the file via the GitHub API (produces a verified signed commit)
          gh api -X PUT repos/aupeachmo/homebrew-aigogo/contents/Formula/aigg.rb \
            --input - <<< "$PAYLOAD"

          echo "Homebrew formula updated to v${VERSION}"
